# ============================================
# Emlak Teknoloji Platformu - Staging Deploy
# Trigger: main branch push veya manual dispatch
# Target: 157.173.116.230 (PM2 managed)
# ============================================

name: Deploy Staging

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Testleri atla (sadece acil durumda)"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: deploy-staging
  cancel-in-progress: false  # Devam eden deploy iptal edilmemeli

env:
  SERVER_HOST: 157.173.116.230
  DEPLOY_PATH: /var/www/uniqmys
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "22"

jobs:
  # ---------- CI Gate: Lint + Test ----------
  ci-gate:
    if: github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_DB: emlak_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        ports: ["5432:5432"]
        options: >-
          --health-cmd "pg_isready -U test_user -d emlak_test"
          --health-interval 10s --health-timeout 5s
          --health-retries 5 --health-start-period 30s
      redis:
        image: redis:7.2-alpine
        ports: ["6379:6379"]
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s --health-timeout 5s --health-retries 5

    env:
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: emlak_test
      DB_USER: test_user
      DB_PASSWORD: test_pass
      REDIS_URL: redis://localhost:6379/0
      APP_ENV: testing
      APP_DEBUG: false
      JWT_SECRET_KEY: test-secret-key-for-ci-only-32chars

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install WeasyPrint system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libgdk-pixbuf-2.0-0 \
            libcairo2 \
            libglib2.0-0 \
            libffi-dev \
            fonts-noto-core \
            fonts-noto-extra

      - name: Install API dependencies
        working-directory: apps/api
        run: uv sync --dev

      - name: Lint (ruff)
        working-directory: apps/api
        run: |
          uv run ruff check src/ tests/
          uv run ruff format --check src/ tests/

      - name: Run tests (including PDF smoke)
        working-directory: apps/api
        run: uv run pytest -v --tb=short

  # ---------- Build API ----------
  build-api:
    needs: [ci-gate]
    if: always() && (needs.ci-gate.result == 'success' || needs.ci-gate.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install production dependencies
        working-directory: apps/api
        run: uv sync --no-dev

      - name: Verify API starts
        working-directory: apps/api
        env:
          APP_ENV: testing
          DB_HOST: localhost
          REDIS_URL: redis://localhost:6379/0
        run: |
          uv run python -c "from src.main import app; print('✓ API import OK')"

      - name: Package API artifact
        run: |
          tar czf api-artifact.tar.gz \
            apps/api/src/ \
            apps/api/pyproject.toml \
            apps/api/uv.lock \
            apps/api/alembic.ini \
            apps/api/alembic/ \
            --exclude='apps/api/src/ml/models/*/lgbm_model.joblib' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            2>/dev/null || \
          tar czf api-artifact.tar.gz \
            apps/api/src/ \
            apps/api/pyproject.toml \
            apps/api/uv.lock \
            --exclude='__pycache__' \
            --exclude='.pytest_cache'

      - name: Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: api-artifact.tar.gz
          retention-days: 3

  # ---------- Build Web ----------
  build-web:
    needs: [ci-gate]
    if: always() && (needs.ci-gate.result == 'success' || needs.ci-gate.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('apps/web/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install dependencies
        working-directory: apps/web
        run: pnpm install --frozen-lockfile

      - name: Build Next.js
        working-directory: apps/web
        env:
          NEXT_TELEMETRY_DISABLED: "1"
        run: pnpm run build

      - name: Package Web artifact
        run: |
          tar czf web-artifact.tar.gz \
            apps/web/.next/ \
            apps/web/public/ \
            apps/web/package.json \
            apps/web/pnpm-lock.yaml \
            apps/web/next.config.* \
            --exclude='apps/web/.next/cache'

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: web-artifact.tar.gz
          retention-days: 3

  # ---------- Deploy to Staging ----------
  deploy:
    needs: [build-api, build-web]
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.uniqmys.com

    steps:
      - uses: actions/checkout@v4

      - name: Download API artifact
        uses: actions/download-artifact@v4
        with:
          name: api-build

      - name: Download Web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Create release directory on server
        run: |
          RELEASE_ID=$(date +%Y%m%d_%H%M%S)_${GITHUB_SHA::8}
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV

          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ env.SERVER_HOST }} << EOSSH
            set -e
            mkdir -p ${{ env.DEPLOY_PATH }}/releases/${RELEASE_ID}
            mkdir -p ${{ env.DEPLOY_PATH }}/shared/logs
            mkdir -p ${{ env.DEPLOY_PATH }}/shared/uploads
          EOSSH

      - name: Upload artifacts to server
        run: |
          scp -i ~/.ssh/deploy_key \
            api-artifact.tar.gz \
            web-artifact.tar.gz \
            ${{ secrets.SSH_USER }}@${{ env.SERVER_HOST }}:/tmp/

      - name: Extract and deploy
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ env.SERVER_HOST }} << 'EOSSH'
            set -e
            RELEASE_DIR="${{ env.DEPLOY_PATH }}/releases/${{ env.RELEASE_ID }}"

            # Extract artifacts
            cd "$RELEASE_DIR"
            tar xzf /tmp/api-artifact.tar.gz
            tar xzf /tmp/web-artifact.tar.gz
            rm -f /tmp/api-artifact.tar.gz /tmp/web-artifact.tar.gz

            # Symlink shared resources
            ln -sfn ${{ env.DEPLOY_PATH }}/shared/.env "$RELEASE_DIR/apps/api/.env"
            ln -sfn ${{ env.DEPLOY_PATH }}/shared/.env.web "$RELEASE_DIR/apps/web/.env.local"
            ln -sfn ${{ env.DEPLOY_PATH }}/shared/logs "$RELEASE_DIR/logs"
            ln -sfn ${{ env.DEPLOY_PATH }}/shared/uploads "$RELEASE_DIR/uploads"

            # Install API production dependencies
            cd "$RELEASE_DIR/apps/api"
            if command -v uv &> /dev/null; then
              uv sync --no-dev
            else
              pip install --no-cache-dir -r <(pip freeze) 2>/dev/null || true
            fi

            # Install Web production dependencies
            cd "$RELEASE_DIR/apps/web"
            pnpm install --frozen-lockfile --prod 2>/dev/null || npm install --production

            # Run DB migrations
            cd "$RELEASE_DIR/apps/api"
            if [ -f alembic.ini ]; then
              echo "Running database migrations..."
              uv run alembic upgrade head 2>/dev/null || alembic upgrade head
            fi

            # Update current symlink (atomic switch)
            ln -sfn "$RELEASE_DIR" "${{ env.DEPLOY_PATH }}/current"

            echo "✓ Release ${{ env.RELEASE_ID }} deployed"
          EOSSH

      - name: Restart services (PM2)
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ env.SERVER_HOST }} << 'EOSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}/current

            # PM2 reload (zero-downtime)
            if [ -f ecosystem.config.js ]; then
              pm2 reload ecosystem.config.js --update-env
            else
              pm2 restart all --update-env
            fi

            # Wait for services to be ready
            sleep 5

            echo "✓ PM2 services reloaded"
          EOSSH

      - name: Health check
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ env.SERVER_HOST }} << 'EOSSH'
            set -e
            MAX_RETRIES=10
            RETRY_DELAY=3

            for i in $(seq 1 $MAX_RETRIES); do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health 2>/dev/null || echo "000")
              if [ "$HTTP_CODE" = "200" ]; then
                echo "✓ API health check passed (attempt $i)"
                break
              fi
              if [ "$i" = "$MAX_RETRIES" ]; then
                echo "✗ API health check FAILED after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "⏳ Waiting for API... (attempt $i/$MAX_RETRIES, HTTP $HTTP_CODE)"
              sleep $RETRY_DELAY
            done

            # Web health check
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "✓ Web health check passed (HTTP $HTTP_CODE)"
            else
              echo "⚠ Web returned HTTP $HTTP_CODE (non-critical)"
            fi
          EOSSH

      - name: Cleanup old releases (keep last 5)
        if: success()
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ env.SERVER_HOST }} << 'EOSSH'
            cd ${{ env.DEPLOY_PATH }}/releases
            ls -dt */ | tail -n +6 | xargs rm -rf 2>/dev/null || true
            echo "✓ Old releases cleaned up (keeping last 5)"
          EOSSH

      - name: Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ env.SERVER_HOST }} << 'EOSSH'
            set -e
            PREVIOUS=$(ls -dt ${{ env.DEPLOY_PATH }}/releases/*/ | head -2 | tail -1)
            if [ -n "$PREVIOUS" ]; then
              ln -sfn "$PREVIOUS" "${{ env.DEPLOY_PATH }}/current"
              pm2 reload ecosystem.config.js --update-env 2>/dev/null || pm2 restart all
              echo "⚠ ROLLED BACK to: $(basename $PREVIOUS)"
            else
              echo "✗ No previous release to rollback to"
              exit 1
            fi
          EOSSH

      - name: Deploy notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
          else
            EMOJI="❌"
          fi
          echo "${EMOJI} Staging deploy ${STATUS}: ${{ env.RELEASE_ID }} (${GITHUB_SHA::8})"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Actor: ${{ github.actor }}"
